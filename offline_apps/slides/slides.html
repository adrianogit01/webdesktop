<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Slides (PowerPoint-like) ‚Äî TinyMCE + Miniaturas + PDF/PPTX + Fullscreen</title>
  <script src="jsbib/tinymce.min.js"></script>
  <script src="jsbib/FileSaver.min.js"></script>
  <script src="jsbib/pptxgen.bundle.min.js"></script>
  <script src="jsbib/html-to-image.min.js"></script>
  <style>
    :root {
      --sidebar-w: 220px;
      --controls-h: 54px;
      --bg: #0f1115;
      --panel: #181b22;
      --panel-2: #1f2430;
      --text: #e8eaf2;
      --muted: #9aa3b2;
      --brand: #4ea1ff;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
      display: grid;
      grid-template-columns: var(--sidebar-w) 1fr;
      grid-template-rows: 1fr var(--controls-h);
      grid-template-areas:
        "thumbs editor"
        "controls controls";
      height: 100vh;
      overflow: hidden;
    }
    aside.thumbs {
      grid-area: thumbs;
      background: var(--panel);
      border-right: 1px solid #222a36;
      padding: 8px;
      overflow: auto;
    }
    .thumb {
      background: var(--panel-2);
      border: 1px solid #2a3140;
      border-radius: 12px;
      margin: 8px 4px;
      padding: 8px;
      cursor: grab;
      transition: transform .12s ease, border-color .12s ease;
    }
    .thumb:active { cursor: grabbing; }
    .thumb:hover { transform: translateY(-2px); border-color: var(--brand); }
    .thumb.active { outline: 2px solid var(--brand); }
    .thumb .thumb-viewport {
      width: 200px;
      height: 112.5px;
      overflow: hidden;
      position: relative;
      background: #fff;
      color: #000;
      border-radius: 8px;
    }
    .thumb .thumb-inner {
      width: 1280px; height: 720px;
      transform: scale(0.15625);
      transform-origin: top left;
      pointer-events: none;
    }
    .thumb .meta { margin-top: 6px; font-size: 12px; color: var(--muted); text-align: center; }
    main.editor-wrap { grid-area: editor; position: relative; }
    #editor { height: calc(100vh - var(--controls-h)); }
    .controls {
      grid-area: controls;
      background: var(--panel);
      border-top: 1px solid #222a36;
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: center;
      padding: 8px;
    }
    .controls button {
      border: 0; border-radius: 999px; padding: 10px 14px; cursor: pointer;
      background: #263044; color: #e6f0ff; font-weight: 600;
    }
    .controls button:hover { background: #31405c; }
    /* As regras abaixo afetam a visualiza√ß√£o no editor TinyMCE (fora do fullscreen) */
    /* OBS: o CSS do documento n√£o entra no iframe do TinyMCE, ent√£o usamos content_style no init para isso. */
    /* Para refer√™ncia, mantemos as classes aqui tamb√©m. */
    .tinymce-content .slide,
    .presentation .slide {
      width: 1280px; height: 720px;
      background: #ffffff; color: #111827;
      padding: 64px; border-radius: 24px;
      box-shadow: 0 1px 0 rgba(0,0,0,.04), 0 12px 40px rgba(0,0,0,.22);
      margin: 24px auto;
    }
    .tinymce-content .slide h1, .presentation .slide h1 { font-size: 56px; margin: 0 0 16px; }
    .tinymce-content .slide h2, .presentation .slide h2 { font-size: 36px; margin: 12px 0; }
    .tinymce-content .slide p, .presentation .slide p { font-size: 20px; line-height: 1.5; }
    #presentation {
      display: none; position: fixed; inset: 0; background: #000; color: #fff;
      align-items: center; justify-content: center; overflow: hidden;
    }
    #presentation .stage { position: relative; }
  </style>
</head>
<body>
  <aside class="thumbs" id="thumbs"></aside>
  <main class="editor-wrap">
    <textarea id="editor">
      <section class="slide"><h1>Bem-vindo</h1><p>Este √© seu editor de slides.</p></section>
      <section class="slide"><h2>Miniaturas</h2><p>A barra lateral mostra preview clic√°vel e reorden√°vel.</p></section>
      <section class="slide"><h2>Exporta√ß√£o</h2><p>PDF via impress√£o. PPTX via snapshots.</p></section>
    </textarea>
  </main>
  <div class="controls">
    <button id="btnPrev">‚óÄ Anterior</button>
    <button id="btnNext">Pr√≥ximo ‚ñ∂</button>
    <button id="btnAdd">‚ûï Novo Slide</button>
    <button id="btnDelete">üóëÔ∏è Excluir Slide</button>
    <button id="btnExportHtml">üíæ Exportar HTML</button>
    <button id="btnExportPdf">üñ®Ô∏è Exportar PDF</button>
    <button id="btnExportPptx">üìë Exportar PPTX</button>
    <button id="btnPresent">üé• Apresentar</button>
  </div>
  <div id="presentation" class="presentation">
    <div class="stage" id="stage"></div>
  </div>
  <script>
    let current = 0;
    let presentationMode = false;
    let rebuildThumbsScheduled = false;

    tinymce.init({
      selector: '#editor',
      height: 'calc(100vh - var(--controls-h))',
      menubar: false,
      plugins: 'code fullscreen lists link image table',
      toolbar: 'undo redo | styles | bold italic underline | alignleft aligncenter alignright | bullist numlist | link image table | code',
      /* aplica estilos dentro do iframe do TinyMCE (centraliza slide e d√° fundo neutro) */
      content_style: `
        html,body{height:100%}
        body{margin:0;background:#0f1115;padding:24px;}
        section.slide{margin:24px auto !important; width:1280px; height:720px; background:#fff; color:#111827; padding:64px; border-radius:24px; box-shadow:0 1px 0 rgba(0,0,0,.04), 0 12px 40px rgba(0,0,0,.22);}
        section.slide h1{font-size:56px;margin:0 0 16px;}
        section.slide h2{font-size:36px;margin:12px 0;}
        section.slide p{font-size:20px;line-height:1.5;}
      `,
      setup(editor){
        editor.on('init', () => { showSlide(0); rebuildThumbnails(); });
        editor.on('Change KeyUp SetContent', () => {
          if (!rebuildThumbsScheduled) {
            rebuildThumbsScheduled = true;
            setTimeout(()=>{ rebuildThumbsScheduled=false; rebuildThumbnails(); }, 250);
          }
        });
      }
    });

    function getSlides(){ return tinymce.get('editor').dom.select('section.slide'); }
    function showSlide(index){
      const slides = getSlides();
      if (!slides.length) return;
      const len = slides.length;
      current = ((index % len) + len) % len;
      slides.forEach((s, i) => { s.style.display = (i === current ? 'block' : 'none'); });
      highlightActiveThumb();
      if (presentationMode) renderStageFrom(slides[current]);
    }
    function nextSlide(){ showSlide(current + 1); }
    function prevSlide(){ showSlide(current - 1); }
    function addSlide(){
      const editor = tinymce.get('editor');
      editor.insertContent('<section class="slide"><h2>Novo Slide</h2><p>Edite aqui...</p></section>');
      const slides = getSlides();
      showSlide(slides.length - 1);
      rebuildThumbnails();
    }
    function deleteSlide(){
      const slides = getSlides();
      if (!slides.length) return;
      if (confirm("Deseja realmente excluir este slide?")) {
        slides[current].remove();
        const newIndex = Math.max(0, current-1);
        showSlide(newIndex);
        rebuildThumbnails();
      }
    }

    function rebuildThumbnails(){
      const thumbs = document.getElementById('thumbs');
      thumbs.innerHTML = '';
      const slides = getSlides();
      slides.forEach((slide, idx) => {
        const wrap = document.createElement('div');
        wrap.className = 'thumb';
        wrap.dataset.index = idx;
        wrap.draggable = true;
        wrap.addEventListener('click', ()=> showSlide(idx));
        wrap.addEventListener('dragstart', dragStart);
        wrap.addEventListener('dragover', dragOver);
        wrap.addEventListener('drop', drop);

        const viewport = document.createElement('div');
        viewport.className = 'thumb-viewport';
        const inner = document.createElement('div');
        inner.className = 'thumb-inner slide';
        inner.innerHTML = slide.innerHTML;
        viewport.appendChild(inner);
        wrap.appendChild(viewport);

        const meta = document.createElement('div');
        meta.className = 'meta';
        meta.textContent = `Slide ${idx+1}`;
        wrap.appendChild(meta);
        thumbs.appendChild(wrap);
      });
      highlightActiveThumb();
    }
    function highlightActiveThumb(){
      const nodes = document.querySelectorAll('.thumb');
      nodes.forEach((n, i)=> n.classList.toggle('active', i===current));
    }

    let dragSrcIndex = null;
    function dragStart(e){ dragSrcIndex = Number(this.dataset.index); }
    function dragOver(e){ e.preventDefault(); }
    function drop(e){
      e.preventDefault();
      const targetIndex = Number(this.dataset.index);
      if (dragSrcIndex === targetIndex) return;
      const slides = getSlides();
      const srcNode = slides[dragSrcIndex];
      const destNode = slides[targetIndex];
      if (srcNode && destNode) {
        if (dragSrcIndex < targetIndex) destNode.after(srcNode);
        else destNode.before(srcNode);
        rebuildThumbnails();
        showSlide(targetIndex);
      }
    }

    function exportHtml(){
      const html = tinymce.get('editor').getContent();
      const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
      saveAs(blob, 'apresentacao.html');
    }

    function exportPdf(){
      const slides = Array.from(getSlides());
      const printWin = window.open('', '_blank');
      const styles = `
        <style>
          @page { size: 1280px 720px; margin: 0; }
          body { margin: 0; background: #000; }
          .page { display: flex; align-items: center; justify-content: center; page-break-after: always; width: 100vw; height: 100vh; }
          .slide { width: 1280px; height: 720px; background: #fff; color:#111827; padding:64px; margin: 0; }
        </style>`;
      const body = slides.map(s => `<div class="page"><section class="slide">${s.innerHTML}</section></div>`).join('');
      printWin.document.write(`<html><head><meta charset="utf-8">${styles}</head><body>${body}</body></html>`);
      printWin.document.close();
      printWin.onload = () => printWin.print();
    }

    async function exportPptx(){
      if (typeof PptxGenJS === 'undefined' || !window.htmlToImage) {
        alert('Exporta√ß√£o PPTX requer jsbib/pptxgen.bundle.min.js e jsbib/html-to-image.min.js');
        return;
      }
      const pptx = new PptxGenJS();
      pptx.layout = 'LAYOUT_16x9';
      const slides = Array.from(getSlides());
      for (let i = 0; i < slides.length; i++) {
        const s = slides[i];
        const tmp = document.createElement('div');
        tmp.style.position = 'fixed'; tmp.style.left = '-20000px'; tmp.style.top = '0';
        tmp.style.width = '1280px'; tmp.style.height = '720px'; tmp.style.background = '#ffffff';
        tmp.className = 'presentation';
        const clone = document.createElement('section');
        clone.className = 'slide';
        clone.style.margin = '0';
        clone.innerHTML = s.innerHTML;
        tmp.appendChild(clone);
        document.body.appendChild(tmp);
        try {
          const dataUrl = await htmlToImage.toPng(tmp, { width: 1280, height: 720, pixelRatio: 2, backgroundColor: '#ffffff' });
          const slide = pptx.addSlide();
          slide.addImage({ data: dataUrl, x: 0, y: 0, w: 10, h: 5.625 });
        } catch (e) { console.error('Erro ao capturar slide:', e); }
        finally { document.body.removeChild(tmp); }
      }
      await pptx.writeFile({ fileName: 'apresentacao.pptx' });
    }

    function fitStage(){
      const stage = document.getElementById('stage');
      const W = window.innerWidth, H = window.innerHeight;
      const scale = Math.min(W/1280, H/720);
      stage.style.width = '1280px';
      stage.style.height = '720px';
      stage.style.position = 'absolute';
      stage.style.top = '50%';
      stage.style.left = '50%';
      stage.style.transform = `translate(-50%, -50%) scale(${scale})`;
      stage.style.transformOrigin = 'center center';
    }
    function renderStageFrom(slideNode){
      const stage = document.getElementById('stage');
      stage.innerHTML = '';
      const clone = document.createElement('section');
      clone.className = 'slide'; clone.style.margin = '0'; clone.innerHTML = slideNode.innerHTML;
      stage.appendChild(clone);
      fitStage();
    }
    function startPresentation(){
      const pres = document.getElementById('presentation');
      pres.style.display = 'flex';
      presentationMode = true;
      const slides = getSlides();
      renderStageFrom(slides[current]);
      if (pres.requestFullscreen) pres.requestFullscreen();
      else if (pres.webkitRequestFullscreen) pres.webkitRequestFullscreen();
      else if (pres.msRequestFullscreen) pres.msRequestFullscreen();
    }
    function exitPresentation(){
      presentationMode = false;
      document.getElementById('presentation').style.display = 'none';
    }
    document.addEventListener('fullscreenchange', () => {
      if (!document.fullscreenElement && presentationMode) exitPresentation();
    });

    document.getElementById('btnPrev').addEventListener('click', prevSlide);
    document.getElementById('btnNext').addEventListener('click', nextSlide);
    document.getElementById('btnAdd').addEventListener('click', addSlide);
    document.getElementById('btnDelete').addEventListener('click', deleteSlide);
    document.getElementById('btnExportHtml').addEventListener('click', exportHtml);
    document.getElementById('btnExportPdf').addEventListener('click', exportPdf);
    document.getElementById('btnExportPptx').addEventListener('click', exportPptx);
    document.getElementById('btnPresent').addEventListener('click', startPresentation);

    document.addEventListener('keydown', (e)=>{
      if (presentationMode){
        if (e.key === 'ArrowRight') nextSlide();
        if (e.key === 'ArrowLeft') prevSlide();
        if (e.key === 'Escape') document.exitFullscreen();
      } else {
        if (e.key === 'ArrowRight') nextSlide();
        if (e.key === 'ArrowLeft') prevSlide();
      }
    });
    window.addEventListener('resize', () => { if (presentationMode) fitStage(); });
  </script>
</body>
</html>
